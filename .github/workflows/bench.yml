name: Bench

concurrency:
    group: bench-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on:
    workflow_dispatch:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_call:

jobs:
    prepare:
        uses: NikolaRHristov/bench-piscina/.github/workflows/Node.yml@main

    bench:
        needs: prepare
        strategy:
            matrix:
                node-version: [18]
                toolchain: ["nightly"]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3.5.3

            # Setup Node
            - uses: pnpm/action-setup@v2.4.0
              with:
                  version: 8.6.6
                  run_install: |
                      - recursive: true
                        args: [
                          --child-concurrency=9999,
                          --link-workspace-packages=true,
                          --lockfile-only,
                          --network-concurrency=9999,
                          --prefer-frozen-lockfile=false,
                          --shamefully-hoist=false,
                          --shared-workspace-lockfile=true,
                          --strict-peer-dependencies=false,
                          --unsafe-perm=true
                        ]
            - uses: actions/setup-node@v3.7.0
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "pnpm"
                  cache-dependency-path: ./pnpm-lock.yaml
            - run: pnpm install
              working-directory: .

            # Setup Rust
            - uses: actions-rs/toolchain@v1.0.7
              with:
                  profile: minimal
                  toolchain: ${{ matrix.toolchain }}
            - uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                      Target/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('./Cargo.toml') }}
            - uses: actions-rs/install@v0.1.2
              with:
                  crate: hyperfine
                  use-tool-cache: true

            # Download the production build from Node.yml
            - uses: actions/download-artifact@v3.0.2
              id: download
              with:
                  name: .-node-${{ matrix.node-version }}-Target
                  path: ./Target

            # Run the benchmark
            - run: |
                  chmod a+x ./bench.sh
                  ./bench.sh

            # Commit the results
            - run: |
                  git add bench/
                  git add README.md
                  git config --global user.name 'Bench'
                  git config --global user.email 'bench@nikolahristov.tech'
                  git commit -m "Auto Bench $(git log -1 --pretty=%h) $(git log -1 --pretty=%B)"
                  git push
